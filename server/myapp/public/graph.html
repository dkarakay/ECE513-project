<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sensor Data Visualization</title>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Date Adapter (date-fns) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        label, select, input, button {
            margin: 5px;
        }
        /* Header Styling */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        /* Home Button Styling */
        #homeButton {
            padding: 8px 16px;
            background-color: #007BFF; /* Bootstrap Primary Blue */
            color: white;
            text-decoration: none;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #homeButton:hover {
            background-color: #0056b3;
        }
        /* Control Panel Styling */
        .controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .controls > div {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        /* Summary and Charts Sections */
        #weeklySummary, #dailyCharts {
            max-width: 800px;
            margin-top: 20px;
        }
        .summary-item {
            margin: 5px 0;
        }
        /* Canvas Styling */
        canvas {
            max-width: 800px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Header Section with Home Button -->
    <div class="header">
        <h1>Sensor Data Visualization</h1>
        <!-- Home Button -->
        <a href="http://ec2-3-143-111-57.us-east-2.compute.amazonaws.com:3000/index.html" id="homeButton">Home</a>
    </div>
    
    <!-- Control Panel -->
    <div class="controls">
        <!-- View Selection -->
        <div>
            <label for="viewType">View:</label>
            <select id="viewType" name="viewType">
                <option value="weekly">Weekly Summary</option>
                <option value="daily">Detailed Daily</option>
            </select>
        </div>
        
        <!-- Date Selection (Visible only for Detailed Daily View) -->
        <div id="datePickerContainer" style="display: none;">
            <label for="selectedDate">Select Date:</label>
            <input type="date" id="selectedDate" name="selectedDate">
        </div>
        
        <!-- Time-of-Day Range -->
        <div>
            <label for="startTime">Start Time:</label>
            <input type="time" id="startTime" name="startTime" value="00:00">
            
            <label for="endTime">End Time:</label>
            <input type="time" id="endTime" name="endTime" value="23:59">
        </div>
        
        <!-- Measurement Frequency -->
        <div>
            <label for="frequency">Measurement Frequency (minutes):</label>
            <select id="frequency" name="frequency">
                <option value="15">15</option>
                <option value="30" selected>30</option>
                <option value="60">60</option>
            </select>
        </div>
        
        <!-- Generate View Button -->
        <div>
            <button id="generateView">Generate View</button>
        </div>
    </div>
    
    <!-- Weekly Summary Section -->
    <div id="weeklySummary" style="display: none;">
        <h2>Weekly Summary (Past 7 Days)</h2>
        <div class="summary-item"><strong>Average Heart Rate:</strong> <span id="avgHeartRate">--</span> BPM</div>
        <div class="summary-item"><strong>Minimum Heart Rate:</strong> <span id="minHeartRate">--</span> BPM</div>
        <div class="summary-item"><strong>Maximum Heart Rate:</strong> <span id="maxHeartRate">--</span> BPM</div>
    </div>
    
    <!-- Detailed Daily Charts Section -->
    <div id="dailyCharts" style="display: none;">
        <h2>Detailed Daily View</h2>
        <canvas id="heartRateChart"></canvas>
        <canvas id="spo2Chart"></canvas>
    </div>
    
    <script>
        let heartRateChart = null;
        let spo2Chart = null;

        // Toggle visibility of date picker based on view type
        document.getElementById('viewType').addEventListener('change', function() {
            const view = this.value;
            const datePicker = document.getElementById('datePickerContainer');
            if (view === 'daily') {
                datePicker.style.display = 'flex';
            } else {
                datePicker.style.display = 'none';
            }
        });

        // Event listener for Generate View button
        document.getElementById('generateView').addEventListener('click', function() {
            const viewType = document.getElementById('viewType').value;
            const frequency = parseInt(document.getElementById('frequency').value);
            const startTimeInput = document.getElementById('startTime').value;
            const endTimeInput = document.getElementById('endTime').value;

            // Validate time inputs
            if (!startTimeInput || !endTimeInput) {
                alert('Please specify both start and end times.');
                return;
            }

            const startTimeParts = startTimeInput.split(':').map(Number);
            const endTimeParts = endTimeInput.split(':').map(Number);

            if (startTimeParts.length !== 2 || endTimeParts.length !== 2) {
                alert('Invalid time format.');
                return;
            }

            // Initialize start and end times
            let startTime, endTime;

            if (viewType === 'weekly') {
                endTime = new Date(); // Current time
                startTime = new Date(endTime.getTime() - 7 * 24 * 60 * 60 * 1000); // 7 days ago
            } else if (viewType === 'daily') {
                const selectedDate = document.getElementById('selectedDate').value;
                if (!selectedDate) {
                    alert('Please select a date for Detailed Daily View.');
                    return;
                }
                const [year, month, day] = selectedDate.split('-').map(Number);
                startTime = new Date(year, month - 1, day, startTimeParts[0], startTimeParts[1]);
                endTime = new Date(year, month - 1, day, endTimeParts[0], endTimeParts[1]);

                if (isNaN(startTime) || isNaN(endTime)) {
                    alert('Invalid date or time.');
                    return;
                }

                if (startTime >= endTime) {
                    alert('Start time must be before end time.');
                    return;
                }
            }

            // Construct API URL with parameters
            const apiUrl = `http://ec2-3-143-111-57.us-east-2.compute.amazonaws.com:3000/sensor/all?start=${startTime.toISOString()}&end=${endTime.toISOString()}&frequency=${frequency}`;
            console.log('Fetching data from:', apiUrl);

            // Fetch data from API
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Data fetched:', data);
                    if (!Array.isArray(data) || data.length === 0) {
                        alert('No data available for the selected time range.');
                        return;
                    }

                    if (viewType === 'weekly') {
                        displayWeeklySummary(data);
                    } else if (viewType === 'daily') {
                        displayDetailedDailyView(data, startTime, endTime);
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    alert(`Failed to fetch data: ${error.message}`);
                });
        });

        /**
         * Displays the Weekly Summary View.
         * Calculates and shows average, min, and max heart rate over the past 7 days.
         * @param {Array} data - Array of sensor data objects.
         */
        function displayWeeklySummary(data) {
            // Filter heart rate data
            const heartRates = data
                .filter(entry => typeof entry.bpm === 'number')
                .map(entry => entry.bpm);

            if (heartRates.length === 0) {
                alert('No valid heart rate data available.');
                return;
            }

            // Calculate statistics
            const averageHR = calculateAverage(heartRates);
            const minHR = Math.min(...heartRates);
            const maxHR = Math.max(...heartRates);

            // Update summary in the DOM
            document.getElementById('avgHeartRate').textContent = averageHR;
            document.getElementById('minHeartRate').textContent = minHR;
            document.getElementById('maxHeartRate').textContent = maxHR;

            // Show Weekly Summary and hide Detailed Daily Charts
            document.getElementById('weeklySummary').style.display = 'block';
            document.getElementById('dailyCharts').style.display = 'none';
        }

        /**
         * Displays the Detailed Daily View.
         * Plots heart rate and SpO2 readings on separate charts with min and max indicators.
         * @param {Array} data - Array of sensor data objects.
         * @param {Date} startTime - Start time of the data range.
         * @param {Date} endTime - End time of the data range.
         */
        function displayDetailedDailyView(data, startTime, endTime) {
            // Process heart rate data
            const heartRateData = data
                .filter(entry => typeof entry.bpm === 'number')
                .map(entry => ({
                    x: new Date(entry.created_at),
                    y: entry.bpm
                }));

            // Process SpO2 data
            const spo2Data = data
                .filter(entry => typeof entry.spo2 === 'number')
                .map(entry => ({
                    x: new Date(entry.created_at),
                    y: entry.spo2
                }));

            // Check if there is data to plot
            if (heartRateData.length === 0 && spo2Data.length === 0) {
                alert('No valid heart rate or SpO₂ data available.');
                return;
            }

            // Calculate statistics for Heart Rate
            const bpmValues = heartRateData.map(entry => entry.y);
            const avgBPM = calculateAverage(bpmValues);
            const minBPM = Math.min(...bpmValues);
            const maxBPM = Math.max(...bpmValues);

            // Calculate statistics for SpO2
            const spo2Values = spo2Data.map(entry => entry.y);
            const avgSpO2 = calculateAverage(spo2Values);
            const minSpO2 = Math.min(...spo2Values);
            const maxSpO2 = Math.max(...spo2Values);

            // Prepare Heart Rate Chart
            const hrCtx = document.getElementById('heartRateChart').getContext('2d');
            if (heartRateChart) {
                heartRateChart.destroy();
            }

            heartRateChart = new Chart(hrCtx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Heart Rate (BPM)',
                            data: heartRateData,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Minimum BPM',
                            data: heartRateData.map(entry => ({ x: entry.x, y: minBPM })),
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                            borderDash: [5, 5],
                            showLine: true,
                            order: 2
                        },
                        {
                            label: 'Maximum BPM',
                            data: heartRateData.map(entry => ({ x: entry.x, y: maxBPM })),
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                            borderDash: [5, 5],
                            showLine: true,
                            order: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Heart Rate Over Time'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            display: true
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    scales: {
                        x: { 
                            type: 'time',
                            time: { 
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                },
                                tooltipFormat: 'PPpp'
                            },
                            title: {
                                display: true,
                                text: 'Time of Day'
                            },
                            min: startTime,
                            max: endTime
                        },
                        y: { 
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Heart Rate (BPM)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });

            // Prepare SpO2 Chart
            const spo2Ctx = document.getElementById('spo2Chart').getContext('2d');
            if (spo2Chart) {
                spo2Chart.destroy();
            }

            spo2Chart = new Chart(spo2Ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'SpO₂ Level (%)',
                            data: spo2Data,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Minimum SpO₂',
                            data: spo2Data.map(entry => ({ x: entry.x, y: minSpO2 })),
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                            borderDash: [5, 5],
                            showLine: true,
                            order: 2
                        },
                        {
                            label: 'Maximum SpO₂',
                            data: spo2Data.map(entry => ({ x: entry.x, y: maxSpO2 })),
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                            borderDash: [5, 5],
                            showLine: true,
                            order: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'SpO₂ Levels Over Time'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            display: true
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    scales: {
                        x: { 
                            type: 'time',
                            time: { 
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                },
                                tooltipFormat: 'PPpp'
                            },
                            title: {
                                display: true,
                                text: 'Time of Day'
                            },
                            min: startTime,
                            max: endTime
                        },
                        y: { 
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'SpO₂ Level (%)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });

            // Show Detailed Daily Charts and hide Weekly Summary
            document.getElementById('dailyCharts').style.display = 'block';
            document.getElementById('weeklySummary').style.display = 'none';
        }

        /**
         * Calculates the average of an array of numbers.
         * @param {number[]} numbers - Array of numerical values.
         * @returns {number} - The average value rounded to two decimal places.
         */
        function calculateAverage(numbers) {
            if (numbers.length === 0) return 0;
            const sum = numbers.reduce((acc, val) => acc + val, 0);
            return parseFloat((sum / numbers.length).toFixed(2));
        }

        /**
         * Initializes default values when the page loads.
         */
        window.onload = function() {
            const viewType = document.getElementById('viewType');
            const datePicker = document.getElementById('datePickerContainer');

            // Set default view to Weekly Summary
            viewType.value = 'weekly';
            datePicker.style.display = 'none';

            // Set default time-of-day range
            document.getElementById('startTime').value = '00:00';
            document.getElementById('endTime').value = '23:59';

            // Set default measurement frequency
            document.getElementById('frequency').value = '30';
        };
    </script>
</body>
</html>